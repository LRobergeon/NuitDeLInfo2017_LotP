<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Sarouleman</title>
        <link href='http://fonts.googleapis.com/css?family=Varela+Round' rel='stylesheet' type='text/css'>
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href="http://netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
        <link href="css/flexslider.css" rel="stylesheet" >
        <link href="css/styles.css" rel="stylesheet">
        <link href="css/queries.css" rel="stylesheet">
        <link href="css/animate.css" rel="stylesheet">
        <link href="http://www.jqueryscript.net/css/jquerysctipttop.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="css/progres-bar.css">
        <link href="css/gameLoic.css" rel="stylesheet">
        <style type="text/css">
            #map {
                width: 100%;
                height: 100%;
                position: absolute;
            }
        </style>
        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
    <body id="top">
        <header id="home">
            <section class="hero" id="hero">
                <div class="container">
                    <div class="row">
                        <div class="col-md-12 text-right navicon">
                            <div class="mediPlayer">
                                <audio id="audio" class="listen" preload="none" data-size="80" src="assets/Steppenwolf - Born To Be Wild.mp3"></audio>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-8 col-md-offset-2 text-center inner">
                            <h1 class="animated fadeInDown">SAROULEMAN<span></span></h1>
                            <p class="animated fadeInUp delay-05s">Une application pour la <em>sécurité routière</em></p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 col-md-offset-3 text-center">
                            <img class="animated hinge zoomIn delay-05s" id="logo" src="img/saroulemane.gif"/>
                        </div>
                        </section>
                        </header>
                        <section class="intro text-center section-padding" id="intro">
                            <div class="container">
                                <h3>My Google Maps Demo</h3>
                                <div id="map" style="height: 400px; width: 100%;"></div>

                            </div>
                        </section>
                        <section class="features text-center section-padding" id="features">
                            <div class="container">
                                <h1>What's the problem ?</h1>

                                <button>Say the problem</button>

                                <div>
                                    <p class="phrase">Phrase...</p>
                                    <p class="result">Right or wrong?</p>
                                    <p class="output">...diagnostic messages</p>
                                </div>
                            </div>
                        </section>
                        <section class="text-center" id="responsive">
                            <div class="container-fluid nopadding responsive-services">
                                <h1>The whack a mole game!!</h1>
                                <p>(Click on the mole)</p>
                                <div class="container">
                                    <div class="main-controls main-cell">
                                        <button id='start-game'>
                                            Start the game!
                                        </button>
                                    </div>
                                    <div class="main-grid main-cell">
                                        <div id="grid"></div>
                                    </div>
                                    <div class="main-score main-cell">
                                        <div class="timer-label">Timer:</div>
                                        <div id="timer"></div>
                                        <div class="score-label">Score:</div>
                                        <div id="score">0</div>
                                        <div id="scoreFaux">0</div>
                                        <div>
                                            <p></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>
                        <footer>
                            <div class="container">
                                <div class="row">
                                    <div class="col-md-6">
                                        <ul class="legals">
                                            <li><a href="#">L'équipe Lord Of The Ping</a></li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6 credit">
                                        <p>Un projet créer pour <a href="www.nuitdelinfo.com"><em>la nuit de l'info</em></a></p>
                                    </div>
                                </div>
                            </div>
                        </footer>
                        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
                        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
                        <!-- Include all compiled plugins (below), or include individual files as needed -->
                        <script src="js/waypoints.min.js"></script>
                        <script src="js/bootstrap.min.js"></script>
                        <script src="js/scripts.js"></script>
                        <script src="js/jquery.flexslider.js"></script>
                        <script src="js/modernizr.js"></script>
                        <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
                        <script src="js/player.js"></script>
                        <script src="js/voiceLoic.js"></script>
                        <script src="js/gameLoic.js"></script>
                        <script>
                            $(document).ready(function () {
                                $('.mediPlayer').mediaPlayer();
                                $('.controls').click();
                            });

                            function handleNotifications(map, pos, msg) {
                                var infoWindow = new google.maps.InfoWindow({map: map});
                                infoWindow.setPosition(pos);
                                infoWindow.setContent(msg);
                            }
                            function humanizeGeolocationErrorMsg(error) {
                                switch (error.code) {
                                    case error.PERMISSION_DENIED:
                                        return "User denied the request for Geolocation.";
                                    case error.POSITION_UNAVAILABLE:
                                        return "Location information is unavailable.";
                                    case error.TIMEOUT:
                                        return "The request to get user location timed out.";
                                    case error.UNKNOWN_ERROR:
                                        return "An unknown error occurred."
                                }
                            }
                            function initMap() {
                                var officePos = {lat: 50.438284, lng: 30.515339};
                                var map = new google.maps.Map(document.getElementById('map'), {
                                    zoom: 15,
                                    center: officePos
                                });

                                var directionsService = new google.maps.DirectionsService;
                                var directionsRenderer = new google.maps.DirectionsRenderer({map: map});
                                if (navigator.geolocation) {
                                    navigator.geolocation.getCurrentPosition(
                                            function (position) {
                                                var currentPos = {lat: position.coords.latitude, lng: position.coords.longitude};

                                                directionsService.route({
                                                    origin: currentPos,
                                                    destination: officePos,
                                                    travelMode: google.maps.TravelMode.DRIVING
                                                }, function (response, status) {
                                                    if (status === google.maps.DirectionsStatus.OK) {
                                                        directionsRenderer.setDirections(response);
                                                    } else {
                                                        handleNotifications(map, map.getCenter(), 'Directions request failed!');
                                                    }
                                                });
                                            }, function (error) {
                                        handleNotifications(map, map.getCenter(), humanizeGeolocationErrorMsg(error));
                                    }
                                    )
                                } else {
                                    handleNotifications(map, map.getCenter(), "Your browser doesn't support html5 geolocation");
                                }
                            }
                        </script>

                        <!--<script src="https://cdn.firebase.com/js/client/2.3.2/firebase.js"></script>-->
                        <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>

                        <script>

                              // var firebase = new Firebase("https://mapfirebase-fda6d.firebaseio.com");
                              // Initialize Firebase
                              var config = {
                                  apiKey: "AIzaSyDxTxQOulNCYykJVFaNpxjgMXiIj4O0y-w",
                                  authDomain: "mapfirebase-fda6d.firebaseapp.com",
                                  databaseURL: "https://mapfirebase-fda6d.firebaseio.com",
                                  projectId: "mapfirebase-fda6d",
                                  storageBucket: "mapfirebase-fda6d.appspot.com",
                                  messagingSenderId: "63828048135"
                              };
                              firebase.initializeApp(config);


                              /**
                               * Data object to be written to Firebase.
                               */
                              var data = {
                                  sender: null,
                                  timestamp: null,
                                  lat: null,
                                  lng: null
                              };

                              function makeInfoBox(controlDiv, map) {
                                  // Set CSS for the control border.
                                  var controlUI = document.createElement('div');
                                  controlUI.style.boxShadow = 'rgba(0, 0, 0, 0.298039) 0px 1px 4px -1px';
                                  controlUI.style.backgroundColor = '#fff';
                                  controlUI.style.border = '2px solid #fff';
                                  controlUI.style.borderRadius = '2px';
                                  controlUI.style.marginBottom = '22px';
                                  controlUI.style.marginTop = '10px';
                                  controlUI.style.textAlign = 'center';
                                  controlDiv.appendChild(controlUI);

                                  // Set CSS for the control interior.
                                  var controlText = document.createElement('div');
                                  controlText.style.color = 'rgb(25,25,25)';
                                  controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
                                  controlText.style.fontSize = '100%';
                                  controlText.style.padding = '6px';
                                  controlText.textContent = 'The map shows all clicks made in the last 10 minutes.';
                                  controlUI.appendChild(controlText);
                              }

                              /**
                               * Starting point for running the program. Authenticates the user.
                               * @param {function()} onAuthSuccess - Called when authentication succeeds.
                               */
                              function initAuthentication(onAuthSuccess) {

                                  firebase.auth().signInAnonymously().catch(function (error, authData) {
                                      if (error) {
                                          // Handle Errors here.
                                          var errorCode = error.code;
                                          var errorMessage = error.message;
                                          console.log('Login Failed!', error.message);
                                      } else {
                                          data.sender = authData.uid;
                                          onAuthSuccess();
                                      }
                                  }, {remember: 'sessionOnly'});
                              }

                              /**
                               * Creates a map object with a click listener and a heatmap.
                               */
                              function initMap() {
                                  var map = new google.maps.Map(document.getElementById('map'), {
                                      center: {lat: 0, lng: 0},
                                      zoom: 3,
                                      styles: [{
                                              featureType: 'poi',
                                              stylers: [{visibility: 'off'}]  // Turn off POI.
                                          },
                                          {
                                              featureType: 'transit.station',
                                              stylers: [{visibility: 'off'}]  // Turn off bus, train stations etc.
                                          }],
                                      disableDoubleClickZoom: true,
                                      streetViewControl: false,
                                  });
                                  var infoWindow = new google.maps.InfoWindow({map: map});
                                  console.log(navigator.geolocation);
                                  // Try HTML5 geolocation.
                                  if (navigator.geolocation) {
                                      navigator.geolocation.getCurrentPosition(function (position) {
                                          var pos = {
                                              lat: position.coords.latitude,
                                              lng: position.coords.longitude
                                          };

                                          infoWindow.setPosition(pos);
                                          infoWindow.setContent('Location found.');
                                          console.log(pos);
                                          map.setCenter(pos);
                                      }, function () {
                                          handleLocationError(true, infoWindow, map.getCenter());
                                      });
                                  } else {
                                      // Browser doesn't support Geolocation
                                      handleLocationError(false, infoWindow, map.getCenter());
                                  }


                                  function handleLocationError(browserHasGeolocation, infoWindow, pos) {
                                      infoWindow.setPosition(pos);
                                      infoWindow.setContent(browserHasGeolocation ?
                                              'Error: The Geolocation service failed.' :
                                              'Error: Your browser doesn\'t support geolocation.');
                                  }

                                  // Create the DIV to hold the control and call the makeInfoBox() constructor
                                  // passing in this DIV.
                                  var infoBoxDiv = document.createElement('div');
                                  makeInfoBox(infoBoxDiv, map);
                                  map.controls[google.maps.ControlPosition.TOP_CENTER].push(infoBoxDiv);

                                  // Listen for clicks and add the location of the click to firebase.
                                  map.addListener('click', function (e) {
                                      data.lat = e.latLng.lat();
                                      data.lng = e.latLng.lng();
                                      addToFirebase(data);
                                  });

                                  // Create a heatmap.


                                  var map = new google.maps.visualization.HeatmapLayer({
                                      data: [],
                                      map: map,
                                      radius: 16
                                  });


                                  initAuthentication(initFirebase(map));
                              }

                              /**
                               * Set up a Firebase with deletion on clicks older than expirySeconds
                               * @param {!google.maps.visualization.HeatmapLayer} heatmap The heatmap to
                               * which points are added from Firebase.
                               */
                              function initFirebase(map) {
                                  // 10 minutes before current time.
                                  var startTime = new Date().getTime() - (60 * 10 * 1000);

                                  // Reference to the clicks in Firebase.
                                  var clicks = firebase.database().ref('clicks');


                                  // Listener for when a click is added.
                                  clicks.orderByChild('timestamp').startAt(startTime).on('child_added', function (snapshot) {

                                      // Get that click from firebase.
                                      var newPosition = snapshot.val();
                                      var point = new google.maps.LatLng(newPosition.lat, newPosition.lng);
                                      var elapsed = new Date().getTime() - newPosition.timestamp;

                                      // Add the point to  the heatmap.
                                      map.getData().push(point);

                                      // Requests entries older than expiry time (10 minutes).
                                      var expirySeconds = Math.max(60 * 10 * 1000 - elapsed, 0);
                                      // Set client timeout to remove the point after a certain time.
                                      window.setTimeout(function () {
                                          // Delete the old point from the database.
                                          snapshot.ref().remove();
                                      }, expirySeconds);
                                  }
                                  );

                                  // Remove old data from the heatmap when a point is removed from firebase.
                                  clicks.on('child_removed', function (snapshot, prevChildKey) {
                                      var mapData = map.getData();
                                      var i = 0;
                                      while (snapshot.val().lat != mapData.getAt(i).lat()
                                              || snapshot.val().lng != mapData.getAt(i).lng()) {
                                          i++;
                                      }
                                      mapData.removeAt(i);
                                  });
                              }

                              /**
                               * Updates the last_message/ path with the current timestamp.
                               * @param {function(Date)} addClick After the last message timestamp has been updated,
                               *     this function is called with the current timestamp to add the
                               *     click to the firebase.
                               */
                              function getTimestamp(addClick) {
                                  // Reference to location for saving the last click time.
                                  //var ref = firebase.child('last_message/' + data.sender);
                                  var ref = firebase.database().ref('last_message/' + data.sender);

                                  ref.onDisconnect().remove();  // Delete reference from firebase on disconnect.

                                  // Set value to timestamp.
                                  ref.set(firebase.database.ServerValue.TIMESTAMP, function (err) {
                                      if (err) {  // Write to last message was unsuccessful.
                                          console.log(err);
                                      } else {  // Write to last message was successful.
                                          ref.once('value', function (snap) {
                                              addClick(snap.val());  // Add click with same timestamp.
                                          }, function (err) {
                                              console.warn(err);
                                          });
                                      }
                                  });
                              }

                              /**
                               * Adds a click to firebase.
                               * @param {Object} data The data to be added to firebase.
                               *     It contains the lat, lng, sender and timestamp.
                               */
                              function addToFirebase(data) {
                                  getTimestamp(function (timestamp) {
                                      // Add the new timestamp to the record data.
                                      data.timestamp = timestamp;
                                      var ref = firebase.database().ref('clicks').push(data, function (err) {
                                          if (err) {  // Data was not written to firebase.
                                              console.warn(err);
                                          }
                                      });
                                  });
                              }
                        </script>
                        <script async defer
                                src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBF-xVgwPsPlKOaAK3X0ux8q83dvjqrPwY&libraries=visualization&callback=initMap">
                        </script>
                        <!--<script src="https://maps.googleapis.com/maps/api/js?callback=initMap&quot; async defer></script>-->
                        </body>
                        </html>
